head	1.10;
access;
symbols;
locks
	ersmith:1.10;
comment	@ * @;


1.10
date	93.06.15.23.20.42;	author ersmith;	state Exp;
branches;
next	1.9;

1.9
date	93.06.14.23.48.02;	author ersmith;	state Exp;
branches;
next	1.8;

1.8
date	93.06.09.23.47.00;	author ersmith;	state Exp;
branches;
next	1.7;

1.7
date	93.05.12.15.50.18;	author ersmith;	state Exp;
branches;
next	1.6;

1.6
date	93.04.27.23.00.14;	author ersmith;	state Exp;
branches;
next	1.5;

1.5
date	93.04.14.22.19.54;	author ersmith;	state Exp;
branches;
next	1.4;

1.4
date	93.03.12.19.51.12;	author ersmith;	state Exp;
branches;
next	1.3;

1.3
date	93.03.10.20.12.42;	author ersmith;	state Exp;
branches;
next	1.2;

1.2
date	93.03.08.20.07.02;	author ersmith;	state Exp;
branches;
next	1.1;

1.1
date	93.02.24.23.52.46;	author ersmith;	state Exp;
branches;
next	1.0;

1.0
date	93.02.03.21.26.46;	author ersmith;	state Exp;
branches;
next	;


desc
@Cartridge code
@


1.10
log
@Minor fixups, resource file cleanup etc.
@
text
@/* INCLUDES
 * =======================================================================
 */
#include "pgem.h"
#include "pmisc.h"

#include "machine.h"
#include "pdstruct.h"
#include "gemdos.h"


BYTE	*g2_name( BYTE *file );



/* DEFINES
 * =======================================================================
 */
#define CART_BASE 0xFA0000L
#define CART_START 0xFA0004L
#define CART_MAGIC 0xABCDEF42L
#define CA_ISCRYS 0x40000000L
#define CA_ISPARM 0x80000000L
#define TEXTBASE 8



/* EXTERNS
 * =======================================================================
 */
EXTERN WORD	DOS_AX;
EXTERN BYTE	dtabuf[];	/* dta buffer	*/
EXTERN BYTE	*runacc;





/* STRUCTURES
 * =======================================================================
 */
#define CARTNODE struct cartnode
CARTNODE
{
	CARTNODE	*c_next;
	LONG		*c_init;
	LONG		*c_code;
	WORD		c_time;
	WORD		c_date;
	LONG		c_size;
	BYTE		c_name[14];
};


CARTNODE *cart_find( WORD fill );
GLOBAL CARTNODE		*cart_ptr;
GLOBAL BYTE		*cart_dta;


/* FUNCTIONS
 * =======================================================================
 */
	WORD
cart_init( VOID )
{
	cart_ptr = ((CARTNODE *)CART_BASE);
	if (cart_ptr->c_next == ( CARTNODE *)CART_MAGIC )
	{
	  cart_ptr = ((CARTNODE *)CART_START);
	  return(TRUE);
	}
	else
	{
	  cart_ptr = ( CARTNODE *)NULLPTR;
	  return(FALSE);
	}
}


	CARTNODE
*cart_find(fill)
	WORD	fill;
{
	REG BYTE	*pdta;
	REG CARTNODE	*pcart;

	if (cart_ptr)
	{
	  if (fill)
	  {
	    pdta = cart_dta;
	    bfill(42,NULL, &pdta[0]);		/* zero it out	*/
	    pdta[21] = F_RDONLY;		/* fill time,date,size,name */
   	    LBCOPY( &pdta[22], ( BYTE *)&cart_ptr->c_time, 21 );	
	  }
	  pcart = cart_ptr;
	  cart_ptr = cart_ptr->c_next;		/* point to next	*/
	  return(pcart);
	}
	return( ( CARTNODE *)NULLPTR );
}


	WORD
cart_sfirst(pdta, attr)
	BYTE	*pdta;
	WORD	attr;
{
	cart_dta = pdta;
	cart_init();
	return(	cart_snext() );
}

	WORD
cart_snext( VOID )
{
	if (cart_find(TRUE))
	  return(TRUE);
	else
	{
	  DOS_AX = E_NOFILES;
	  return(FALSE);
	}
}

#if 0
DISABLED FOR NOW...CJG 03/24/93
	VOID
ld_cartacc( VOID )
{
	REG BYTE		*psp;
	REG CARTNODE		*pcart;
	PD			*p;

	cart_init();

	while ( pcart = cart_find(FALSE) )
	{
	  if ( wildcmp( "*.ACC", &pcart->c_name[0]) )
	  {

 	    /* WARNING - this was...			CJG 02/19/93 
	     *  if ( p = get_pd() )
	     * This is supposed to be a cartridge accessory SO.....
	     */

	    if ( p = get_pd( &pcart->c_name[0], AESACC ) )		/* create PD	*/
	    {

	      psp = ( BYTE *)dos_exec( ( LONG )0L, 5, ( LONG )0L);

	      LLSET(&psp[TEXTBASE], ( LONG )pcart->c_code);
						/* go for it	*/
/*	      pstart(p, runacc, psp, (BYTE*)0, (BYTE*)0, 0 );	*/
	      pstart(p, ( WORD(*)())runacc, psp );	/* CJG 02/19/93 */
	    }
	    else
	    {
	      free_pd( p );
	      break;
	    }
	  }
	}
}
#endif


#if 0
DISABLEd TEMPORARY...CJG 03/24/93	
	WORD
cart_exec(pcmd, ptail)
	BYTE	*pcmd,*ptail;
{
	REG BYTE		*psp;
	REG CARTNODE		*pcart;

	cart_init();

	while (pcart = cart_find(FALSE) )
	{
	  if ( strcmp(pcmd, &pcart->c_name[0]) )
	    break;
	}
	psp = ( BYTE *)dos_exec( ( LONG)"", 5, ( LONG )ptail);

	LLSET(&psp[TEXTBASE], ( LONG )pcart->c_code);
	dos_exec( ( LONG )"", 4, ( LONG )psp);
	dos_free( *(LONG*)(&psp[0x2c]) );
	dos_free( ( LONG )psp );
	return(TRUE);
}
#endif



	WORD
c_sfirst( path )
	BYTE	*path;
{
	BYTE		*file;
	CARTNODE	*pcart;
 
	file = g2_name( path );
	cart_init();
	while ( pcart = cart_find(FALSE) )
	{
	  if ( strcmp( file, &pcart->c_name[0]) )
	    return( TRUE );
	}

	return( FALSE );
}




	BYTE
*g2_name( file )
	BYTE	*file;
{	
	BYTE	*tail;

	tail = r_slash( file );
	if ( *tail == '\\' )
	  tail++;
	
	return( tail );
}
@


1.9
log
@Merged in Hans-Martin and Cary's changes
@
text
@@


1.8
log
@Another check in to save work.
@
text
@@


1.7
log
@Check in to save work
@
text
@@


1.6
log
@Merged Cary's and Hans-Martin's changes
@
text
@a0 47
/*
 *************************************************************************
 *			Revision Control System
 * =======================================================================
 *  $Revision: 1.4 $	$Source: f:\multitos/RCS/romcart.c,v $
 * =======================================================================
 *  $Author: ersmith $	$Date: 1993/03/12 19:51:12 $	$Locker: ersmith $
 * =======================================================================
 *  $Log: romcart.c,v $
 * Revision 1.4  1993/03/12  19:51:12  ersmith
 * Merged HMK's loadable resource stuff
 *
 * Revision 1.3  1993/03/10  20:12:42  ersmith
 * Lattice port
 *
 *
 * Revision 1.1  1993/02/24  23:52:46  ersmith
 * 1 meg floppy MultiTOS
 *
 * Revision 1.0  1993/02/03  21:26:46  ersmith
 * MultiTOS version 1.0
 *
 * Revision 2.2  89/04/26  18:30:35  mui
 * TT
 * 
 * Revision 2.1  89/02/22  05:32:18  kbad
 * *** TOS 1.4  FINAL RELEASE VERSION ***
 * 
 * Revision 1.1  88/06/02  12:36:19  lozben
 * Initial revision
 * 
 *	ROMCART.C		2/26/85 - 04/14/85	Lowell Webster	
 *	remove cart_start	06/10/85		Mike Schmal	
 *	Fix the cart_exe	07/09/85		Derek Mui	
 *	Fix the cart_app	3/21/86			Derek Mui	
 *	Added sh_rom at cart_find	3/21/86		Derek Mui	
 *	Comment out cart_app	7/2/86			Derek Mui	
 *	Take out sh_rom		7/2/86			Derek Mui	
 *	Clean up		1/21/88			D.Mui		
 *	Added c_sfirst()	6/18/90			D.Mui		
 *									
 *	Converted to Lattice C 5.51	2/16/93		C.Gee		
 *	Force the use of prototypes	2/19/93		C.Gee		
 *	WARNING - See ld_acc() and its use of get_pd()
 *************************************************************************
 */

@


1.5
log
@Incorporated more single/multitasking changes.
@
text
@d173 2
d212 1
d214 3
d239 2
@


1.4
log
@Merged HMK's loadable resource stuff
@
text
@d5 1
a5 1
 *  $Revision: 1.3 $	$Source: f:\multitos/RCS/romcart.c,v $
d7 1
a7 1
 *  $Author: ersmith $	$Date: 1993/03/10 20:12:42 $	$Locker: ersmith $
d10 3
@


1.3
log
@Lattice port
@
text
@d5 1
a5 1
 *  $Revision: 1.1 $	$Source: f:\multitos/RCS/romcart.c,v $
d7 1
a7 1
 *  $Author: ersmith $	$Date: 1993/02/24 23:52:46 $	$Locker: ersmith $
d9 4
a12 1
 *  $Log:	romcart.c,v $
@


1.2
log
@REAL MultiTOS 1.01
@
text
@d2 9
a10 8
*************************************************************************
*			Revision Control System
* =======================================================================
*  $Revision: 1.1 $	$Source: f:\multitos/RCS/romcart.c,v $
* =======================================================================
*  $Author: ersmith $	$Date: 1993/02/24 23:52:46 $	$Locker: ersmith $
* =======================================================================
*  $Log: romcart.c,v $
d14 41
a54 26
* Revision 2.2  89/04/26  18:30:35  mui
* TT
* 
* Revision 2.1  89/02/22  05:32:18  kbad
* *** TOS 1.4  FINAL RELEASE VERSION ***
* 
* Revision 1.1  88/06/02  12:36:19  lozben
* Initial revision
* 
*************************************************************************
*/
/*	ROMCART.C		2/26/85 - 04/14/85	Lowell Webster	*/
/*	remove cart_start	06/10/85		Mike Schmal	*/
/*	Fix the cart_exe	07/09/85		Derek Mui	*/
/*	Fix the cart_app	3/21/86			Derek Mui	*/
/*	Added sh_rom at cart_find	3/21/86		Derek Mui	*/
/*	Comment out cart_app	7/2/86			Derek Mui	*/
/*	Take out sh_rom		7/2/86			Derek Mui	*/
/*	Clean up		1/21/88			D.Mui		*/
/*	Added c_sfirst()	6/18/90			D.Mui		*/


#include <portab.h>
#include <machine.h>
#include <pdstruct.h>
#include <gemdos.h>
d56 4
d67 5
a71 4
EXTERN BYTE	*dos_exec();
EXTERN WORD	wildcmp();
EXTERN PD	*pstart();
EXTERN PD	*get_pd();
a72 1
EXTERN BYTE	*g_name();
d74 2
a77 1
EXTERN BYTE	*runacc;
d80 3
d95 2
d101 5
a105 2

cart_init()
d108 1
a108 1
	if (cart_ptr->c_next == CART_MAGIC )
d115 1
a115 1
	  cart_ptr = NULLPTR;
d135 1
a135 1
   	    LBCOPY( &pdta[22], &cart_ptr->c_time, 21 );	
d141 1
a141 1
	return(NULLPTR);
d156 1
a156 1
cart_snext()
d167 2
a168 2
	WORD
ld_cartacc()
d180 7
a186 1
	    if ( p = get_pd() )			/* create PD	*/
d188 4
a191 2
	      psp = dos_exec("", 5, "");	/* create psp	*/
	      LLSET(&psp[TEXTBASE], pcart->c_code);
d193 2
a194 1
	      pstart(p, runacc, psp, (BYTE*)0, (BYTE*)0, 0 );	
d219 4
a222 3
	psp = dos_exec( "", 5, ptail);
	LLSET(&psp[TEXTBASE], pcart->c_code);
	dos_exec( "", 4, psp);
d224 1
a224 1
	dos_free(psp);
d236 1
a236 1
	file = g_name( path );
d245 16
@


1.1
log
@1 meg floppy MultiTOS
@
text
@d5 1
a5 1
*  $Revision: 2.2 $	$Source: /u2/MRS/osrevisions/aes/romcart.c,v $
d7 1
a7 1
*  $Author: mui $	$Date: 89/04/26 18:30:35 $	$Locker: kbad $
d9 4
a12 1
*  $Log:	romcart.c,v $
@


1.0
log
@MultiTOS version 1.0
@
text
@@
