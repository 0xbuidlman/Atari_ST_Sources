;pour le facteur on prend comme point de repere 320,ok ???
largeur=	319
hauteur=	190

	LEA.L 	PILE,SP
	CLR.L	-(SP)
	MOVE.W	#$20,-(SP)
	TRAP	#1
	ADDQ.L	#6,SP
	BSR	INITS
*	BSR	MAKE_PAL
	LEA	LIGNE_TAB,A5
	BSR	PRECALC
*	BSR	CLS
**************************BOUCLE PRINCIPALE*************************************************
	LEA	LIGNE_TAB,A5
	MOVE.L	#0,ROZO
	MOVE.W	(A5),D2
ZOOM_IN
	bsr	VBL
	CLR.L	$FFFF9800
	BSR	EFFA
	BSR	AFF_ZOOM
	MOVE.W	(A5),D2
	CMPI.L	#280000*2,ROZO
	BHI.S	NO_ROZO
	MOVE.W	(A5)+,D2
	ADD.L	D2,ROZO
NO_ROZO
	MOVE.L	AFFECR,A0
	MOVE.L	WORKECR,A1
	MOVE.L	A1,AFFECR
	MOVE.L	A0,WORKECR
	move.b 	affecr+1,$ffff8201.w
	move.b 	affecr+2,$ffff8203.w
	CMPI.B	#56,$FFFFC02
	BNE.S	NO_ALT
	MOVE.L	#$FF,$FFFF9800
NO_ALT
	CMPI.B	#57,$FFFFC02
	BNE.S	ZOOM_IN
	BRA	FIN
***************************INITIALISATIONS*********************************************************
INITS
	MOVEC.L	CACR,D0			
	MOVE.L	D0,OLD_CACR
	MOVE.L	#$2510,D0		;coupe cache
	MOVEC.L	D0,CACR

	MOVE.W	#2,-(SP)
	TRAP	#14
	ADDQ.L	#2,SP
	MOVE.L	D0,OLDXBIOS2
	
	MOVE.W	#-1,-(SP)		
	MOVE.W	#88,-(SP)		
	TRAP	#14			
	ADDQ.L	#4,SP			
	MOVE.W	D0,OLDMODECODE	

	MOVE.L	#SCREEN,D0	
	ADD.L	#10000,D0
	ANDI.L	#$FFFFFF00,D0
	MOVE.L	D0,SCREEN_ADD

;		  XXXXXXXFSOPV8NNN : flags pour rezs
 	MOVE.W	#%0000000000100010,-(SP)	
	MOVE.W	#3,-(SP)
	MOVE.L	SCREEN_ADD,-(SP)
	MOVE.L	SCREEN_ADD,-(SP)
	MOVE.W	#5,-(SP)
	TRAP	#14
	LEA	14(SP),SP

 	move.l	$44e.w,d0
	MOVE.L	d0,A1
	add.l	#46080,d0
	MOVE.L	d0,A2
	MOVE.L	A1,AFFECR
	MOVE.L	A2,WORKECR
	RTS
***********************SOUS ROUTINES****************************************************
VBL:
	MOVE.L	D0,-(SP)
	move.l	$466.w,d0		
VSYNC:	cmp.l	$466.w,d0
	BEQ.S	VSYNC
	MOVE.L	(SP)+,D0
	RTS
AFF_IMG
	MOVE.L	AFFECR,A0
*	LEA	IMAGE+34,A1
	MOVE.W	#7999,D1
OK
	MOVE.L	(A1)+,(A0)+
	DBF	D1,OK
	RTS
MAKE_PAL
	MOVE.L	#$FFFF8240,A0
	MOVEQ	#15,D1
	LEA	IMAGE+2,A1
PAL
	BSR	VBL
	MOVE.W	(A1)+,(A0)+
	DBF	D1,PAL
	RTS
EFFA
	MOVEM.L	A1/D1,-(SP)
	MOVE.L	WORKECR,A1			; adresse ecran dans a1
	MOVEQ.W	#0,D0
	MOVEQ.W	#52,D1	
	LEA	12000(A1),A1
	MOVE	#$3111,D7
	MOVEC	D7,CACR
.EFF
	REPT	80
	MOVE.W	D0,(A1)+
	ENDR 	
	DBF	D1,.EFF	
	MOVEM.L	(SP)+,A1/D1
	MOVE	#$2510,D7
	MOVEC	D7,CACR
	RTS	
PRECALC
	BSR	ZOOM

	CMPI.W	#2*10,XFACTEUR
	BHI.S	BIG
	ADDQ.W	#2,XFACTEUR
	ADDQ.W	#2,YFACTEUR
	MOVE.W	LIGNE,D2
	ADD.L	D2,ROZO
	MOVE.W	D2,(A5)+
	BRA	PRECALC
BIG
	RTS

AFF_ZOOM
	MOVE.L	#PREC,A1
	MOVE.L	WORKECR,A0
*	LEA	12000(A0),A0
	ADD.L	ROZO,A1
	LSR	#2,D2
AF_ZOM
	MOVE.L	(A1)+,(A0)+
	DBF	D2,AF_ZOM
	RTS

********************ZZZOOOOOOOOOOOOOOOOOOOOOOOMMMMMMMMMMMMMMMMMM**********************************
ZOOM
;on prend les addresses de base(A5,A6,D1,D2)
	MOVE.L	A5,-(SP)
	MOVE.W	#160,LIGNE
	LEA	IMAGE+34,A5
	MOVE.L	#PREC,A6
	ADD.L	ROZO,A6
	MOVE.W	Xfacteur,D1	;D1 compteur pour x
	MOVE.W	Yfacteur,D2	;D2 compteur pour y
	MOVE.W	#largeur,D3	;D3 fait les 320 pix
	MOVE	#hauteur,D4	;D4 fait 40 lignes
	MOVEQ	#0,D5		;D5 compteur pour numero du pts image
;centre /x
	MOVE	#320,d6
	SUB.W	xFACTEUR,D6
	LSL.W	D6
;centre /y
;on fait le zoom
ZOOMER_Y
	ADD.W	yfacteur,D2	
	MOVE.W	#largeur,D3	;D3 fait les 320 pix
 	CMPI.W	#320,D2
	BLE	ZOOMER_X1
	ADD.W	#160,LIGNE
	LEA	160(A6),A6	;ligne ecran suivante
	SUBI.W	#320,D2
	MOVEM.L	D2/D4,-(SP)
ZOOMER_X
	ADD.W	xfacteur,D1	
	CMPI.W	#320,D1		;si facteur>320 affiche le point
	BLE.S	NO_POINT
	BSR.S	MAKE_POINT
	ADDQ.W	#1,D6		;point ecran suivant
	SUBI.W	#320,D1
NO_POINT
	ADDQ.W	#1,D5		;point image suivant
	DBF	D3,ZOOMER_X
	MOVEM.L	(SP)+,D2/D4
ZOOMER_X1
	MOVEQ	#0,D5		;remise a 0 pour nouvelle ligne
	MOVE	#320,d6		;centre les /x
	SUB.W	xFACTEUR,D6
	LSR.W	D6
	LEA	160(A5),A5	;ligne image suivante
	DBF	D4,ZOOMER_Y
	MOVE.L	(SP)+,A5
	RTS

;procedure chargee de voir quel point il faut afficher
MAKE_POINT
; conversion de coordonnees en adresse ecran
; les x	
	MOVE.W	D5,D2
	MOVE.W	D5,D7
	LSR.W	D2
	ANDI.W	#$FFF8,D2
; le decalage
	ANDI.W	#$F,D7			; decalage sur 16 pixels	
	LSL.W	#2,D7
	JMP	DECA_TAB(PC,D7.W)
DECA_TAB
	BRA.W	DECA0
	BRA.W	DECA1
	BRA.W	DECA2
	BRA.W	DECA3
	BRA.W	DECA4
	BRA.W	DECA5
	BRA.W	DECA6
	BRA.W	DECA7                                     
	BRA.W	DECA8
	BRA.W	DECA9
	BRA.W	DECA10
	BRA.W	DECA11
	BRA.W	DECA12
	BRA.W	DECA13
	BRA.W	DECA14
	BRA.W	DECA15
DECA0
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%10000000000000001000000000000000,D7
	ANDI.L	#%10000000000000001000000000000000,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT
DECA1
	MOVE.L	(A5,D2.W),D7
	MOVE.L 	4(A5,D2.W),D4
	ANDI.L	#%01000000000000000100000000000000,D7
	ANDI.L	#%01000000000000000100000000000000,D4
	ROL.L	#1,D7					
	ROL.L	#1,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT
DECA2
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00100000000000000010000000000000,D7
	ANDI.L	#%00100000000000000010000000000000,D4
	ROL.L	#2,D7					
	ROL.L	#2,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT
DECA3
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00010000000000000001000000000000,D7
	ANDI.L	#%00010000000000000001000000000000,D4
	ROL.L	#3,D7					
	ROL.L	#3,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT	
DECA4
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00001000000000000000100000000000,D7
	ANDI.L	#%00001000000000000000100000000000,D4
	ROL.L	#4,D7					
	ROL.L	#4,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT
DECA5
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00000100000000000000010000000000,D7
	ANDI.L	#%00000100000000000000010000000000,D4
	ROL.L	#5,D7					
	ROL.L	#5,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT
DECA6
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00000010000000000000001000000000,D7
	ANDI.L	#%00000010000000000000001000000000,D4
	ROL.L	#6,D7					
	ROL.L	#6,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT
DECA7
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00000001000000000000000100000000,D7
	ANDI.L	#%00000001000000000000000100000000,D4
	ROL.L	#7,D7					
	ROL.L	#7,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT	
DECA8
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00000000100000000000000010000000,D7
	ANDI.L	#%00000000100000000000000010000000,D4
	ROL.L	#8,D7					
	ROL.L	#8,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT	
DECA9
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00000000010000000000000001000000,D7
	ANDI.L	#%00000000010000000000000001000000,D4
	ROL.L	#8,D7					
	ROL.L	#1,D7
	ROL.L	#8,D4
	ROL.L	#1,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT	
DECA10
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00000000001000000000000000100000,D7
	ANDI.L	#%00000000001000000000000000100000,D4
	ROL.L	#8,D7					
	ROL.L	#2,D7
	ROL.L	#8,D4
	ROL.L	#2,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT	
DECA11
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00000000000100000000000000010000,D7
	ANDI.L	#%00000000000100000000000000010000,D4
	ROL.L	#8,D7					
	ROL.L	#3,D7
	ROL.L	#8,D4
	ROL.L	#3,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT	
DECA12
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00000000000010000000000000001000,D7
	ANDI.L	#%00000000000010000000000000001000,D4
	ROL.L	#8,D7					
	ROL.L	#4,D7
	ROL.L	#8,D4
	ROL.L	#4,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	JMP	AFFPOINT
DECA13
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00000000000001000000000000000100,D7
 	ANDI.L	#%00000000000001000000000000000100,D4
	ROL.L	#8,D7					
	ROL.L	#5,D7
	ROL.L	#8,D4
	ROL.L	#5,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	ANDI.W	#$F,D2
	ADD.W	D2,D2
	ADD.W	D2,D2
	JMP	AFF_POINT(PC,D2.W)
	
DECA14
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00000000000000100000000000000010,D7
	ANDI.L	#%00000000000000100000000000000010,D4
	ROL.L	#8,D7					
	ROL.L	#6,D7
	ROL.L	#8,D4
	ROL.L	#6,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	ANDI.W	#$F,D2
	ADD.W	D2,D2
	ADD.W	D2,D2
	JMP	AFF_POINT(PC,D2.W)
	
DECA15
	MOVE.L	(A5,D2.W),D7
	MOVE.L	4(A5,D2.W),D4
	ANDI.L	#%00000000000000010000000000000001,D7
	ANDI.L	#%00000000000000010000000000000001,D4
	ROL.L	#8,D7					
	ROL.L	#7,D7
	ROL.L	#8,D4
	ROL.L	#7,D4
	MOVE.W	D6,D0
	MOVE.W	D6,D2
	LSR.W	D0
	ANDI.W	#$FFF8,D0
	ANDI.W	#$F,D2
	ADD.W	D2,D2
	ADD.W	D2,D2
	JMP	AFF_POINT(PC,D2.W)	
*******************
AFFPOINT
	ANDI.W	#$F,D2
	ADD.W	D2,D2
	ADD.W	D2,D2
	JMP	AFF_POINT(PC,D2.W)	
AFF_POINT
	BRA.W	AFF0
	BRA.W	AFF1
	BRA.W	AFF2
	BRA.W	AFF3
	BRA.W	AFF4
	BRA.W	AFF5
	BRA.W	AFF6
	BRA.W	AFF7
	BRA.W	AFF8
	BRA.W	AFF9
	BRA.W	AFF10
	BRA.W	AFF11
	BRA.W	AFF12
	BRA.W	AFF13
	BRA.W	AFF14
	BRA.W	AFF15
AFF0
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS
AFF1
	ROR.L	#1,D7
	ROR.L	#1,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS
AFF2
	ROR.L	#2,D7
	ROR.L	#2,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS
AFF3
	ROR.L	#3,D7
	ROR.L	#3,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS

AFF4
	ROR.L	#4,D7
	ROR.L	#4,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS

AFF5
	ROR.L	#5,D7
	ROR.L	#5,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS

AFF6
	ROR.L	#6,D7
	ROR.L	#6,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS

AFF7
	ROR.L	#7,D7
	ROR.L	#7,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS

AFF8
	ROR.L	#8,D7
	ROR.L	#8,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS
AFF9
	ROR.L	#8,D7
	ROR.L	#1,D7
	ROR.L	#8,D4
	ROR.L	#1,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS
AFF10
	ROR.L	#8,D7
	ROR.L	#2,D7
	ROR.L	#8,D4
	ROR.L	#2,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS
AFF11
	ROR.L	#8,D7
	ROR.L	#3,D7
	ROR.L	#8,D4
	ROR.L	#3,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS
AFF12
	ROR.L	#8,D7
	ROR.L	#4,D7
	ROR.L	#8,D4
	ROR.L	#4,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS
AFF13
	ROR.L	#8,D7
	ROR.L	#5,D7
	ROR.L	#8,D4
	ROR.L	#5,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS
AFF14
	ROR.L	#8,D7
	ROR.L	#6,D7
	ROR.L	#8,D4
	ROR.L	#6,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS
AFF15
	ROR.L	#8,D7
	ROR.L	#7,D7
	ROR.L	#8,D4
	ROR.L	#7,D4
	OR.L	D7,(A6,D0.W)
	OR.L	D4,4(A6,D0.W)
	RTS

*******************c'est FI-NI********************************************************************

FIN	
	MOVE.B	#15,$484.W
	MOVE.B	#8,$FFFFC02
	MOVE.L	OLD_CACR,D0
	MOVEC.L	D0,CACR
	MOVE.W	OLDMODECODE,-(SP)
	MOVE.W	#3,-(SP)	
	MOVE.L	OLDXBIOS2,-(SP)
	MOVE.L	OLDXBIOS2,-(SP)
	MOVE.W	#5,-(SP)
	TRAP	#14
	LEA	14(SP),SP		
	MOVE.W	#$20,-(SP)
	TRAP	#1
	ADDQ.L	#2,SP
	CLR.W	-(SP)
	TRAP	#1	

	SECTION	DATA
IMAGE		INCBIN	"A:cachere.gif"
AFFECR:		DC.L 	0
WORKECR:		DC.L 	0
OLDXBIOS2:		DC.L	0
SCREEN_ADD		DC.L	0
XFACTEUR		DC.W	2
YFACTEUR		DC.W	2
ROZO		DC.L	0
LIGNE		DC.W	0
		SECTION BSS
		DS.L 	2000
PILE		DS.L 	10
PREC		DS.w 	640000
LIGNE_TAB		DS.W	200
SCREEN		DS.W	200000
OLD_CACR		DS.L	1
OLDMODECODE	DS.W	1
	END