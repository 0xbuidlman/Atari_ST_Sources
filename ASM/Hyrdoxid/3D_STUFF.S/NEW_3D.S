nbpts=	4
	SECTION	TEXT

 	LEA.L 	PILE,SP
	CLR.L	-(SP)
	MOVE.W	#$20,-(SP)
	TRAP	#1
	ADDQ.L	#6,SP
	CLR.B	$484.W
	MOVE.B	#18,$FFFFC02
	move.l	$70.w,OLD_VBL
	move.l	#NEW_VBL,$70.w
*	move.b	$ffffa09,OLD_A09
*	move.b	#$40,$fffa09
	BSR	INITS
	BSR	CLS
	BSR	CLR_REGISTERS
*******
LOOP
	clr.l	$ffff9800
	move.l	#$ffff00ff,$ffff9804
	bsr	EFFA
	bsr	AFF_DOTS
	bsr	TRACE
	MOVEM.L	A0-A2,-(SP)		; syncro ecran
	MOVE.L	AFFECR,A1
	MOVE.L	WORKECR,A2
	MOVE.L	A2,AFFECR
	MOVE.L	A1,WORKECR
	move.b	affecr+1,$ffff8201.w
	move.b 	affecr+2,$ffff8203.w
	MOVEM.L	(SP)+,A0-A2
	CMPI.B	#56,$FFFFC02
	BNE.S	NO_ALT
	MOVE.L	#$FF,$FFFF9800
NO_ALT
	ADDQ	#6,Y_ANGLE
	CMPI.W	#720,Y_ANGLE
	BLT.S	NO_STOP
	CLR	Y_ANGLE
NO_STOP
	BSR	VBL
	CMPI.B	#57,$FFFFC02
	BNE	LOOP
*******

	BRA	SORTIE
***************************INITIALISATIONS*********************************************************
INITS
	MOVEC.L	CACR,D0			
	MOVE.L	D0,OLD_CACR
	MOVE.L	#$2510,D0		;coupe cache
	MOVEC.L	D0,CACR

	MOVE.W	#2,-(SP)
	TRAP	#14
	ADDQ.L	#2,SP
	MOVE.L	D0,OLDXBIOS2
	
	MOVE.W	#-1,-(SP)		
	MOVE.W	#88,-(SP)		
	TRAP	#14			
	ADDQ.L	#4,SP			
	MOVE.W	D0,OLDMODECODE	

	MOVE.L	#SCREEN,D0	
	ADD.L	#10000,D0
	ANDI.L	#$FFFFFF00,D0
	MOVE.L	D0,SCREEN_ADD

;		  XXXXXXXFSOPV8NNN : flags pour rezs
 	MOVE.W	#%0000000001100011,-(SP)	
	MOVE.W	#3,-(SP)
	MOVE.L	SCREEN_ADD,-(SP)
	MOVE.L	SCREEN_ADD,-(SP)
	MOVE.W	#5,-(SP)
	TRAP	#14
	LEA	14(SP),SP

	move	#50,$FFFF82A8.w		;OVER HAUT
	move	#611,$FFFF82AA.w		;BAS

 	move.l $44e.w,d0
	MOVE.L	d0,A1
	add.l	#74240*2,d0
	MOVE.L	d0,A2
	MOVE.L	A1,AFFECR
	MOVE.L	A2,WORKECR
	RTS

	
********************SOUS ROUTINES*****************************************************
NEW_VBL
	addq	#1,$466.w
	rte

CLR_REGISTERS
	movem.l	clr,d0-d6/a0-a6
	rts

AFF_DOTS
	LEA	COS_TAB,A2
	LEA	SIN_TAB,A3
	MOVE	Y_ANGLE,D0
	MOVE	(A2,D0.W),COS_AY	;COS(AY)
	MOVE	(A3,D0.W),SIN_AY	;SIN(AY)
	LEA	XE1,A1
	LEA	DX,A0
	LEA	DY,A4
	LEA	SX,A5
	LEA	SY,A6
	LEA	SZ,A2	
	MOVE.W	#7,D4
	MOVEQ	#10,D0		;pour decalages/512
	MOVE.L	#$3111,D7		;cache on
	MOVEC.L	D7,CACR
ROTATION
	MOVE	COS_AY,D1
	MOVE	SIN_AY,D2	
	MOVE	(A1)+,D3		;X
	MOVE	(A1)+,D6		;Y
	MOVE	(A1)+,D5		;Z
	MOVEQ	#10,D0
******rotation Y
	MOVE	D6,YE		;Y2=Y1
;
	MOVE	D1,D6		
	MOVE	D2,D7
	MULS	D3,D6		;X1*COS(AY)
	ASR.L	D0,D6
	MULS	D5,D7		;Z1*SIN(AY)	
	ASR.L	D0,D7
	ADD.W	D7,D6
	MOVE	D6,XE
;	
	MULS	D1,D5		;Z1*COS(AY)
	ASR.L	D0,D5
	MULS	D3,D2		;X1*SIN(AY)	
	ASR.L	D0,D2
	SUB	D2,D5
	MOVE	D5,ZE
PROJ
	MOVE.W	#512,D3
	MOVE.W	ZE,D1
	ASL.W	D1	;4*ZE
	SUB.W	D1,D3	;512-4*ZE=Q*512
	MOVE.W	XE,D1
	EXT.L	D1
	ASL.L	D0,D1	;XE*512
	DIVS	D3,D1	;XE*512/Q*512=X
	ADD.W	#192,D1	;X EN D1
	MOVE.W	YE,D2
	EXT.L	D2
	ASL.L	D0,D2	
	DIVS	D3,D2
	ADD.W	#135,D2	;Y EN D2
	MOVE	D1,(A0)+
	MOVE	D2,(A4)+
	MOVE	XE,(A5)+
	MOVE	YE,(A6)+
	MOVE	ZE,(A2)+
	DBF	D4,ROTATION
	MOVE.L	#$2510,D0		;cache on
	MOVEC.L	D0,CACR
	RTS		
VBL:
	MOVE.L	D0,-(SP)
	move.l	$466.w,d0		
VSYNC:	cmp.l	$466.w,d0
	BEQ.S	VSYNC
	MOVE.L	(SP)+,D0
	RTS
CLS
	MOVEM.L	D0/A0-a1,-(SP)
	MOVE.L	AFFECR,A0
	MOVE.L	WORKECR,A1
	MOVEQ.L	#0,D1
	MOVE.W	#18269,D0
	MOVE.L	#$3111,D0		;active cache
	MOVEC.L	D0,CACR
OK
	MOVE.L	D1,(A0)+
	MOVE.L	D1,(A1)+
	DBF	D0,OK
	MOVE.L	#$2510,D0		;coupe cache
	MOVEC.L	D0,CACR
	MOVEM.L	(SP)+,D0/A0-a1
	RTS
EFFA
	move.l	WORKECR,a0
	lea	384*3(a0),a0
	moveq	#0,d1
	move	#250,d0
	MOVE.L	#$3111,D7		;active cache
	MOVEC.L	D7,CACR
CLR_1PL
ASM	set	0
	rept	24
	move	d1,ASM(a0)
ASM	set	ASM+16
	endr
	lea	384(a0),a0
	dbf	d0,CLR_1PL
	MOVE.L	#$2510,D0		;coupe cache
	MOVEC.L	D0,CACR
	rts
TRACE
*	MOVE.W	SX+4,X1
*	MOVE.W	SY+4,Y1
*	MOVE.W	SZ+4,Z1
*	MOVE.W	SX+6,X2
*	MOVE.W	SY+6,Y2
*	MOVE.W	SZ+6,Z2
	MOVE.W	SX,X3
	MOVE.W	SY,Y3
	MOVE.W	SZ,Z3
*	BSR	CACHE
*	CMPI.L	#0,D3
*	BLT	NO_FACE
	MOVE.W	DY,PTS
	MOVE.W	DY+2,PTS+2
	MOVE.W	DY+4,PTS+4
	MOVE.W	DY+6,PTS+6
	BSR	INIT_FACE
	MOVE.W	DX,CX1
	MOVE.W	DY,CY1
	MOVE.W	DX+2,CX2
	MOVE.W	DY+2,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+4,CX1
	MOVE.W	DY+4,CY1
	MOVE.W	DX+2,CX2
	MOVE.W	DY+2,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+4,CX1
	MOVE.W	DY+4,CY1
	MOVE.W	DX+6,CX2
	MOVE.W	DY+6,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+6,CX1
	MOVE.W	DY+6,CY1
	MOVE.W	DX,CX2
	MOVE.W	DY,CY2
	BSR	TRACE_FACE
	MOVEQ	#0,D4
	BSR	REMPLI
NO_FACE
	rts
	MOVE.W	SX+8,X1
	MOVE.W	SY+8,Y1
	MOVE.W	SZ+8,Z1
	MOVE.W	SX+14,X2
	MOVE.W	SY+14,Y2
	MOVE.W	SZ+14,Z2
	MOVE.W	SX+12,X3
	MOVE.W	SY+12,Y3
	MOVE.W	SZ+12,Z3
	BSR	CACHE
	CMPI.L	#0,D3
	BLT	NO_FACE2
;face2
	MOVE.W	DY+8,PTS
	MOVE.W	DY+10,PTS+2
	MOVE.W	DY+12,PTS+4
	MOVE.W	DY+14,PTS+6
	BSR	INIT_FACE
	MOVE.W	DX+10,CX1
	MOVE.W	DY+10,CY1
	MOVE.W	DX+12,CX2
	MOVE.W	DY+12,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+8,CX1
	MOVE.W	DY+8,CY1
	MOVE.W	DX+10,CX2
	MOVE.W	DY+10,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+8,CX1
	MOVE.W	DY+8,CY1
	MOVE.W	DX+14,CX2
	MOVE.W	DY+14,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+14,CX1
	MOVE.W	DY+14,CY1
	MOVE.W	DX+12,CX2
	MOVE.W	DY+12,CY2
	BSR	TRACE_FACE
	MOVEQ	#0,D4
	BSR	REMPLI
NO_FACE2
	MOVE.W	SX+10,X1
	MOVE.W	SY+10,Y1
	MOVE.W	SZ+10,Z1
	MOVE.W	SX+2,X2
	MOVE.W	SY+2,Y2
	MOVE.W	SZ+2,Z2
	MOVE.W	SX,X3
	MOVE.W	SY,Y3
	MOVE.W	SZ,Z3
	BSR	CACHE
	CMPI.L	#0,D3
	BLT	NO_FACE3
;face3
	MOVE.W	DY+10,PTS
	MOVE.W	DY,PTS+2
	MOVE.W	DY+2,PTS+4
	MOVE.W	DY+12,PTS+6
	BSR	INIT_FACE
	MOVE.W	DX+10,CX1
	MOVE.W	DY+10,CY1
	MOVE.W	DX,CX2
	MOVE.W	DY,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+2,CX1
	MOVE.W	DY+2,CY1
	MOVE.W	DX+12,CX2
	MOVE.W	DY+12,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+2,CX1
	MOVE.W	DY+2,CY1
	MOVE.W	DX,CX2
	MOVE.W	DY,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+10,CX1
	MOVE.W	DY+10,CY1
	MOVE.W	DX+12,CX2
	MOVE.W	DY+12,CY2
	BSR	TRACE_FACE
	MOVEQ	#4,D4
	BSR	REMPLI
NO_FACE3
	MOVE.W	SX+8,X1
	MOVE.W	SY+8,Y1
	MOVE.W	SZ+8,Z1
	MOVE.W	SX+6,X2
	MOVE.W	SY+6,Y2
	MOVE.W	SZ+6,Z2
	MOVE.W	SX+4,X3
	MOVE.W	SY+4,Y3
	MOVE.W	SZ+4,Z3
	BSR	CACHE
	CMPI.L	#0,D3
	BLT	NO_FACE4
;face4
	MOVE.W	DY+14,PTS
	MOVE.W	DY+4,PTS+2
	MOVE.W	DY+8,PTS+4
	MOVE.W	DY+6,PTS+6
	BSR	INIT_FACE
	MOVE.W	DX+14,CX1
	MOVE.W	DY+14,CY1
	MOVE.W	DX+4,CX2
	MOVE.W	DY+4,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+8,CX1
	MOVE.W	DY+8,CY1
	MOVE.W	DX+6,CX2
	MOVE.W	DY+6,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+6,CX1
	MOVE.W	DY+6,CY1
	MOVE.W	DX+4,CX2
	MOVE.W	DY+4,CY2
	BSR	TRACE_FACE
	MOVE.W	DX+14,CX1
	MOVE.W	DY+14,CY1
	MOVE.W	DX+8,CX2
	MOVE.W	DY+8,CY2
	BSR	TRACE_FACE
	MOVEQ	#4,D4
	BSR	REMPLI
NO_FACE4
	rts
**************************************************************************************
SORTIE	
*	MOVE.B	OLD_A09,$FFFFA09
	MOVE.L	OLD_VBL,$70.W
	MOVE.L	OLD_CACR,D0
	MOVEC.L	D0,CACR
	MOVE.B	#15,$484.W
	MOVE.B	#8,$FFFFC02
	MOVE.W	OLDMODECODE,-(SP)
	MOVE.W	#3,-(SP)	
	MOVE.L	OLDXBIOS2,-(SP)
	MOVE.L	OLDXBIOS2,-(SP)
	MOVE.W	#5,-(SP)
	TRAP	#14
	LEA	14(SP),SP		
	MOVE.W	#$20,-(SP)
	TRAP	#1
	ADDQ.L	#2,SP
	CLR.W	-(SP)
	TRAP	#1

	INCLUDE	"C:\UTILS\CODE_UTI.LS\GEN_ASM\3D_STUFF.S\CACHE3.S"
	INCLUDE	"C:\UTILS\CODE_UTI.LS\GEN_ASM\FULLFACE\3D_256.COL\REMPL256.S"

	SECTION	DATA
OLD_VBL		DC.L	0
OLD_A09		DC.B	0
OLD_CACR		DC.L	0
SCREEN_ADD		DC.L	0
COS_AY		DC.W	0
SIN_AY		DC.W	0
Y_ANGLE		DC.W	0
ZE		DC.W	0
XE		DC.W	0
YE		DC.W	0
X1		DC.W	0
Y1		DC.W	0
Z1		DC.W	0
X2		DC.W	0
Y2		DC.W	0
Z2		DC.W	0
X3		DC.W	0
Y3		DC.W	0
Z3		DC.W	0
AFFECR:		DC.L 	0
WORKECR:		DC.L 	0
OLDXBIOS2:		DC.L	0
OLDMODECODE	DC.W	0
SAV_CY1		DC.W	0
IND		DC.B	0
CX1		DC.W	0
CX2		DC.W	0
CY1		DC.W	0
CY2		DC.W	0
YMAX		DC.W	0
YMIN		DC.W	0
HAUTEUR		DC.W	0
****GRAND CUBE**********
XE1		DC.W	-20
YE1		DC.W	20
ZE1		DC.W	20
;
XE2		DC.W	-20
YE2		DC.W	-20
ZE2		DC.W	20
;
XE3		DC.W	20
YE3		DC.W	-20
ZE3		DC.W	20
;
XE4		DC.W	20
YE4		DC.W	20
ZE4		DC.W	20
;
XE5		DC.W	20
YE5		DC.W	20
ZE5		DC.W	-20
;
XE6		DC.W	-20
YE6		DC.W	20
ZE6		DC.W	-20
;
XE7		DC.W	-20
YE7		DC.W	-20
ZE7		DC.W	-20
;
XE8		DC.W	20
YE8		DC.W	-20
ZE8		DC.W	-20
FORME3		INCBIN	"C:\UTILS\CODE_UTI.LS\GEN_ASM\MULTIPAR.T\V.INL"
FORME		DC.W	%1111111111111111,%0111111111111111,%0011111111111111,%0001111111111111,%0000111111111111,%0000011111111111,%0000001111111111,%0000000111111111,%0000000011111111,%0000000001111111,%0000000000111111,%0000000000011111
		DC.W	%0000000000001111,%0000000000000111,%0000000000000011,%0000000000000001,0
FORME2		DC.W	%1000000000000000,%1100000000000000,%1110000000000000,%1111000000000000,%1111100000000000,%1111110000000000,%1111111000000000,%1111111100000000,%1111111110000000,%1111111111000000,%1111111111100000
		DC.W	%1111111111110000,%1111111111111000,%1111111111111100,%1111111111111110,%1111111111111111
COS_TAB		INCBIN	"F:COSIN2.DAT"
SIN_TAB		EQU	COS_TAB+720	
**************************
Y_TABLE
OXO	SET	0
	REPT	250
	DC.L	OXO
OXO	SET	OXO+384
	ENDR
	DCB.L	500*0
TAB	
OXO	SET	0	
	REPT	24
	DC	32768,OXO,16384,OXO,8192,OXO,4096,OXO
	DC	2048,OXO,1024,OXO,512,OXO,256,OXO
	DC	128,OXO,64,OXO,32,OXO,16,OXO
	DC	8,OXO,4,OXO,2,OXO,1,OXO
OXO	SET	OXO+16
	ENDR
	SECTION	BSS
CLR		DS.L	17
		DS.L	2000
PILE		DS.L	10
SCREEN		DS.W	200000
DX		DS.W	50
DY		DS.W	50
SX		DS.W	50
SY		DS.W	50
SZ		DS.W	50
XMAX		DS.W	300
XMIN		DS.W	300
PTS		DS.W	10
	END
																																																																																																																																															  																									 	  																																		  																																								
																																