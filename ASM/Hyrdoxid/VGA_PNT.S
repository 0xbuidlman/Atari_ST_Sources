* AFFICHAGE D'UNE PIC PNT UNPACKED
* TM - COPYRIGHTS - 94
	OPT	D+

	CLR.L	-(SP)
	MOVE	#32,-(SP)
	TRAP	#1
	ADDQ.L	#6,SP

	BSR	CLS
	move.l	$44E.W,OLDXBIOS

	BSR	VBL
	MOVE.B	#18,$FFFFC02
* MODE FALCON           XXXXXXXFSOPV8NNN : flags pour rezs
 	MOVE.W	#%0000000001100011,-(SP)	
	MOVE	#3,-(SP)
	MOVE.L	#XBIOS3,-(SP)
	MOVE.L	#XBIOS3,-(SP)
	MOVE	#5,-(SP)
	TRAP	#14
	LEA	14(SP),SP

	BSR	CLS
* PALETTE BLACKOS
	BSR	VBL
	LEA	$FFFF9800,A1
	MOVE.L	#255,D0
PAL:	
	CLR.L	(A1)+
	DBF	D0,PAL

* UNE IMAGE VGA = 320 OCTETS+96 DE BORDER R & L
* BORDER = 96 OCTETS SOIT 48 PIXELS PAR BORDER
* BORDER HAUT (NORMAL=111/OVER=48)
	MOVE.W	#51,$FFFF82A8.W
* BORDER BAS (NORMAL=511/OVER=609)
	MOVE.W	#609,$FFFF82AA.W

* INIT SCREEN
	BSR	INITS
	BSR	SYNCHRO
	BSR	CLS_VGA

* PALETTE DE 15 A 255
	BSR	VBL
	MOVEM.L	CLEAR,D0-D7/A0-A6
	LEA	$FFFF9804+4,A1
	LEA	PIC+128+12,A0
	MOVE	#230,D1
LOOP4:
	MOVE	(A0),D0
	LSR	#2,D0
	MOVE.B	D0,COLOR
	MOVE	2(A0),D0
	LSR	#2,D0
	MOVE.B	D0,COLOR+1
	MOVE	4(A0),D0
	LSR	#2,D0
	MOVE.B	D0,COLOR+3
	MOVE.L	COLOR,(A1)+
	ADDQ	#6,A0
	DBF	D1,LOOP4

* PALETTE DE 1 A 14
	BSR	VBL
	MOVEM.L	CLEAR,D0-D7/A0-A6
	LEA	$FFFF9804,A1
	LEA	TABLE,A2
	MOVE	#14,D1
LOOP2:
	LEA	PIC+128+12,A0
	ADD	(A2)+,A0

	MOVE	(A0),D0
	LSR	#2,D0
	MOVE.B	D0,COLOR
	MOVE	2(A0),D0
	LSR	#2,D0
	MOVE.B	D0,COLOR+1
	MOVE	4(A0),D0
	LSR	#2,D0
	MOVE.B	D0,COLOR+3
	MOVE.L	COLOR,(A1)+
	ADDQ	#6,A0
	DBF	D1,LOOP2

* AFFICHAGE GFX	
	MOVEM.L	CLEAR,D0-D7/A0-A6
	MOVE.L	AFFECR,A0
	LEA	384*20(A0),A0
	LEA	PIC+128+(192*8),A1
	MOVE	#(82*279)+(16*10),D0
LOOP3:
	MOVE.L	(A1)+,(A0)+
	DBF	D0,LOOP3
	
BOUCLE:
	BSR	VBL
	CMPI.B	#57,$FFFFC02
	BNE.S	BOUCLE
	
* RESTITUE BORDER HAUT & BAS
FIN:	BSR	CLS
	BSR	VBL
	MOVE	#$FFF,$FFFF8240.W	
	CLR	$FFFF8246.W	
	MOVE.B	#8,$FFFFC02

	BSR	CLS
 	MOVE.W	#1,-(SP)	
	MOVE.L	OLDXBIOS,-(SP)
	MOVE.L	OLDXBIOS,-(SP)
	MOVE	#5,-(SP)
	TRAP	#14
	LEA	12(SP),SP

	MOVE	#32,-(SP)
	TRAP	#1
	ADDQ.L	#4,SP

	CLR.L	-(SP)
	TRAP	#1

VBL:
	move.l	$466.w,d7
VSYNC:	cmp.l	$466.w,D7
	BEQ.S	VSYNC
	RTS

INITS:
	MOVE.L	$44E.W,WORKECR
	MOVE.L	#XBIOS3,D0
	ANDI.L	#$FFFFFF00,D0
	MOVE.L	D0,AFFECR
	RTS

SYNCHRO:
	*MOVE.L	AFFECR,A5
	*MOVE.L	WORKECR,A6
	*EXG	A5,A6
	*MOVE.L	A5,AFFECR
	*MOVE.L	A6,WORKECR

	move.b AFFECR+1,$ffff8201.w
	move.b AFFECR+2,$ffff8203.w
	RTS

CLS:
	MOVE.L	#7999,D0
	MOVE.L	$44E.W,A0
LOOP_CLS:
	CLR.L	(A0)+
	DBF	D0,LOOP_CLS
	RTS

CLS_VGA:
	MOVE.L	AFFECR,A0
	MOVE	#48*279,D0
LOOP_VGA:
	CLR.L	(A0)+ 
	CLR.L	(A0)+
	DBF	D0,LOOP_VGA
	RTS

	SECTION	DATA
PIC:	INCBIN 	F:SAYA.PNT
OLDXBIOS:	DC.L	0
AFFECR:	DC.L	0
WORKECR:	DC.L	0
COLOR:	DC.L	0
TABLE:	DC	0,6,24,12,30,18,36,42,48,54,72,60,78,66,1518
* COLOR		1,2,3, 4, 5, 6 ,7 ,8, 9 ,10,11,12,13,14,15

	SECTION	BSS

CLEAR:	DS.L	16
COL:	DS.L	255
XBIOS2:	DS.L	200
XBIOS3:	DS.B	0

